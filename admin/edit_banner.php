<?php
ini_set('display_errors', 1);
error_reporting(E_ALL);
session_start();

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
if (!isset($_SESSION['user']) || $_SESSION['user']['role'] !== 'admin') {
    header("Location: ../login.php");
    exit;
}

require '../includes/db.php';

// Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å add_banner.php)
function displayMessage($type) {
    if (isset($_GET[$type])) {
        $messages = [
            'updated' => ['class' => 'bg-green-100 text-green-800', 'text' => '‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'],
            'error' => [
                'class' => 'bg-red-100 text-red-800',
                'map' => [
                    'banner_not_found' => '‚ùó ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                    'invalid_banner_id' => '‚ùó ID ‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    'invalid_input' => '‚ùó ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    'invalid_file_type' => '‚ùó ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ JPEG, PNG, GIF, WebP ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                    'file_too_large' => '‚ùó ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)',
                    'upload_failed' => '‚ùó ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ',
                    'db_error' => '‚ùó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                    'default' => '‚ùó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å'
                ]
            ]
        ];

        $msg_config = $messages[$type];
        $text = '';
        if ($type === 'error') {
            $error_code = $_GET['error'] ?? 'default';
            $text = $msg_config['map'][$error_code] ?? $msg_config['map']['default'];
        } else {
            $text = $msg_config['text'];
        }
        echo '<div class="' . $msg_config['class'] . ' p-2 rounded mb-4">' . $text . '</div>';
    }
}


$banner_id = filter_input(INPUT_GET, 'id', FILTER_VALIDATE_INT);
$banner = null;

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
if ($banner_id) {
    $stmt = $pdo->prepare("SELECT id, name, image, link, status FROM banners WHERE id = ?"); // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    $stmt->execute([$banner_id]);
    $banner = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$banner) {
        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        header("Location: manage_banners.php?error=banner_not_found"); // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ manage_banners
        exit;
    }
} else {
    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á id ‡∏°‡∏≤‡πÉ‡∏ô URL
    header("Location: manage_banners.php?error=invalid_banner_id"); // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ manage_banners
    exit;
}

// ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['edit_banner'])) {
    $id = filter_input(INPUT_POST, 'banner_id', FILTER_VALIDATE_INT);
    $name = trim($_POST['name'] ?? '');
    $link = trim($_POST['link'] ?? '');
    $status = $_POST['status'] ?? 'inactive'; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö status ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
    if (!$id || empty($name)) {
        header("Location: edit_banner.php?id=$id&error=invalid_input");
        exit;
    }
    // Validate URL only if not empty
    if (!empty($link) && !filter_var($link, FILTER_VALIDATE_URL)) {
        header("Location: edit_banner.php?id=$id&error=invalid_input"); // ‡∏´‡∏£‡∏∑‡∏≠ error code ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL
        exit;
    }

    $image_path = $banner['image']; // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
    if (isset($_FILES['image']) && $_FILES['image']['error'] === UPLOAD_ERR_OK && !empty($_FILES['image']['name'])) {
        $target_dir = "../uploads/banners/";
        if (!is_dir($target_dir)) {
            mkdir($target_dir, 0755, true); // Changed to 0755
        }

        $allowed_types = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        $max_size = 5 * 1024 * 1024; // 5 MB

        if (!in_array($_FILES['image']['type'], $allowed_types)) {
            header("Location: edit_banner.php?id=$id&error=invalid_file_type");
            exit;
        }
        if ($_FILES['image']['size'] > $max_size) {
            header("Location: edit_banner.php?id=$id&error=file_too_large");
            exit;
        }

        $file_ext = pathinfo($_FILES['image']['name'], PATHINFO_EXTENSION);
        $new_file_name = uniqid('banner_') . '.' . $file_ext; // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
        $target_file = $target_dir . $new_file_name;

        if (move_uploaded_file($_FILES["image"]["tmp_name"], $target_file)) {
            // ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if ($banner['image'] && file_exists("../" . $banner['image'])) {
                unlink("../" . $banner['image']);
            }
            $image_path = "uploads/banners/" . $new_file_name;
        } else {
            header("Location: edit_banner.php?id=$id&error=upload_failed");
            exit;
        }
    } else if (isset($_POST['remove_image']) && $_POST['remove_image'] == '1') {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        if ($banner['image'] && file_exists("../" . $banner['image'])) {
            unlink("../" . $banner['image']);
        }
        $image_path = null;
    }

    try {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á banners
        $stmt = $pdo->prepare("UPDATE banners SET name = ?, image = ?, link = ?, status = ? WHERE id = ?");
        $stmt->execute([$name, $image_path, $link, $status, $id]);

        header("Location: manage_banners.php?updated=1"); // Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ manage_banners
        exit;
    } catch (PDOException $e) {
        error_log("Database error updating banner: " . $e->getMessage());
        header("Location: edit_banner.php?id=$id&error=db_error");
        exit;
    }
}
?>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå: <?= htmlspecialchars($banner['name'] ?? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠') ?></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .preview-img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-gray-100">
<?php require 'header.php'; ?>

<div class="max-w-4xl mx-auto mt-8 p-6 bg-white rounded shadow">
    <h1 class="text-2xl font-bold mb-6">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå: <?= htmlspecialchars($banner['name'] ?? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠') ?></h1>

    <?php displayMessage('updated'); ?>
    <?php displayMessage('error'); ?>

    <form method="post" enctype="multipart/form-data" class="space-y-4">
        <input type="hidden" name="banner_id" value="<?= htmlspecialchars($banner['id']) ?>">
        
        <div>
            <label for="name" class="block text-gray-700 text-sm font-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå:</label>
            <input type="text" name="name" id="name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="<?= htmlspecialchars($banner['name'] ?? '') ?>">
        </div>
        
        <div>
            <label for="link" class="block text-gray-700 text-sm font-bold mb-1">‡∏•‡∏¥‡∏á‡∏Å‡πå (URL):</label>
            <input type="url" name="link" id="link" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="<?= htmlspecialchars($banner['link'] ?? '') ?>" placeholder="https://example.com">
            <p class="text-xs text-gray-500 mt-1">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: https://example.com/your-product</p>
        </div>

        <div>
            <label for="status" class="block text-gray-700 text-sm font-bold mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
            <select name="status" id="status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="active" <?= ($banner['status'] ?? 'inactive') == 'active' ? 'selected' : '' ?>>Active</option>
                <option value="inactive" <?= ($banner['status'] ?? 'inactive') == 'inactive' ? 'selected' : '' ?>>Inactive</option>
            </select>
        </div>

        <div>
            <label class="block text-gray-700 text-sm font-bold mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
            <?php if ($banner['image'] && file_exists("../" . $banner['image'])): ?>
                <img src="../<?= htmlspecialchars($banner['image']) ?>" alt="Current Banner Image" class="mb-2 rounded max-h-48 object-contain border p-1">
                <label class="block mt-2 text-gray-700 text-sm">
                    <input type="checkbox" name="remove_image" value="1" class="mr-2"> ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                </label>
            <?php else: ?>
                <div class="mb-2 text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <?php endif; ?>

            <label for="image" class="block text-gray-700 text-sm font-bold mt-4 mb-1">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô):</label>
            <input type="file" name="image" id="image" accept="image/jpeg, image/png, image/gif, image/webp" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <p class="text-xs text-gray-500 mt-1">‡πÑ‡∏ü‡∏•‡πå: JPEG, PNG, GIF, WebP (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB). ‡∏´‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà</p>
            <img id="image_preview" src="#" alt="Image Preview" class="preview-img hidden">
        </div>

        <div class="text-right flex justify-between items-center">
            <a href="manage_banners.php" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                ‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå
            </a>
            <button type="submit" name="edit_banner" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
        </div>
    </form>
</div>

<script>
    // Image preview script
    document.getElementById('image').addEventListener('change', function(event) {
        const [file] = event.target.files;
        if (file) {
            const preview = document.getElementById('image_preview');
            preview.src = URL.createObjectURL(file);
            preview.classList.remove('hidden');
        }
    });
</script>
</body>
</html>